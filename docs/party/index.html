<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>VRM Sync Test</title>
    <style>
      body {
        margin: 0;
        background: #000;
        overflow: hidden;
      }
      canvas {
        display: block;
      }
      #video {
        display: none;
      }
    </style>
  </head>
  <body>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.177.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/",
          "three/webgpu": "https://cdn.jsdelivr.net/npm/three@0.177.0/build/three.webgpu.js",
          "three/tsl": "https://cdn.jsdelivr.net/npm/three@0.177.0/build/three.tsl.js",
          "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3/lib/three-vrm.module.min.js",
          "@pixiv/three-vrm/nodes": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3/lib/nodes/index.module.js",
          "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22-rc.20250304/+esm"
        }
      }
    </script>
    <script type="module">
      import * as vision from "@mediapipe/tasks-vision";
      import { initScene } from "./scene.js";
      import {
        loadAvatar,
        updateBlendshape,
        changeAvatar,
        updateAvatars,
        avatars,
      } from "./avatarManager.js";

      const getUserId = () => {
        let id = localStorage.getItem("userId");
        if (!id) {
          id = crypto.randomUUID();
          localStorage.setItem("userId", id);
        }
        return id;
      };

      const userId = getUserId();

      const { scene, clock, camera, renderer } = initScene();

      loadAvatar(userId, scene);

      const video = document.getElementById("video");

      const initCamera = async () => {
        video.srcObject = await navigator.mediaDevices.getUserMedia({
          video: true,
        });
        return new Promise((r) => (video.onloadedmetadata = () => r(video)));
      };

      const startFaceTracking = async (video) => {
        const { FaceLandmarker, FilesetResolver } = vision;

        const filesetResolver = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22-rc.20250304/wasm",
        );
        const faceLandmarker = await FaceLandmarker.createFromOptions(
          filesetResolver,
          {
            baseOptions: {
              modelAssetPath:
                "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task",
              delegate: "GPU",
            },
            outputFaceBlendshapes: true,
            outputFacialTransformationMatrixes: true,
            numFaces: 1,
            runningMode: "VIDEO",
          },
        );

        const detect = async () => {
          const result = await faceLandmarker.detectForVideo(
            video,
            performance.now(),
          );
          if (result.faceLandmarks?.length > 0) {
            updateBlendshape(userId, result);
          }
          requestAnimationFrame(detect);
        };
        detect();
      };

      const animate = () => {
        requestAnimationFrame(animate);
        updateAvatars(clock.getDelta());
        renderer.render(scene, camera);
      };

      // ドラッグ＆ドロップ対応
      document.addEventListener("dragover", (e) => e.preventDefault());
      document.addEventListener("drop", async (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (!file.name.endsWith(".vrm")) {
          alert("VRMファイルをドロップしてください");
          return;
        }

        const arrayBuffer = await file.arrayBuffer();
        await changeAvatar(userId, arrayBuffer);
      });

      initCamera().then((v) => startFaceTracking(v));
      animate();
    </script>
    <video id="video" autoplay playsinline></video>
  </body>
</html>
